<div class="activities-graph">
  <h2>Monthly Running Distance</h2>
  <div class="graph-container" id="graph-container">
    <!-- Bars will be generated by JavaScript -->
  </div>
</div>

<script>
(function() {
  // Get activities data from Liquid
  const activities = {{ activities | json }};
  
  // Filter only runs
  const runs = activities.filter(activity => activity.type === 'Run');
  
  // Calculate date range for last 12 months
  const now = new Date();
  const twelveMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 11, 1);
  
  // Group by month (only last 12 months)
  const monthlyData = {};
  
  // Initialize all 12 months with 0 distance
  for (let i = 0; i < 12; i++) {
    const date = new Date(now.getFullYear(), now.getMonth() - 11 + i, 1);
    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    monthlyData[monthKey] = 0;
  }
  
  // Add actual run data
  runs.forEach(run => {
    const runDate = new Date(run.start_date_local);
    
    // Only include runs from the last 12 months
    if (runDate >= twelveMonthsAgo) {
      const monthKey = `${runDate.getFullYear()}-${String(runDate.getMonth() + 1).padStart(2, '0')}`;
      
      if (monthlyData.hasOwnProperty(monthKey)) {
        monthlyData[monthKey] += run.distance;
      }
    }
  });
  
  // Sort months
  const sortedMonths = Object.keys(monthlyData).sort();
  
  // Find max distance for scaling (exclude 0 values)
  const nonZeroDistances = Object.values(monthlyData).filter(distance => distance > 0);
  const maxDistance = nonZeroDistances.length > 0 ? Math.max(...nonZeroDistances) : 1;
  
  // Generate bars
  const container = document.getElementById('graph-container');
  
  sortedMonths.forEach(month => {
    const distance = monthlyData[month];
    const height = distance > 0 ? Math.max((distance / maxDistance) * 100, 2) : 0; // Minimum 2% height for non-zero
    const distanceKm = (distance / 1000).toFixed(1);
    
    const date = new Date(month + '-01');
    const currentYear = new Date().getFullYear();
    const monthLabel = date.getFullYear() === currentYear 
      ? date.toLocaleDateString('en-US', { month: 'short' })
      : date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    
    const barContainer = document.createElement('div');
    barContainer.className = 'bar-container';
    
    const bar = document.createElement('div');
    bar.className = 'bar';
    bar.style.height = height + '%';
    
    // Add opacity for months with no runs
    if (distance === 0) {
      bar.style.opacity = '0.3';
    }
    
    const barLabel = document.createElement('span');
    barLabel.className = 'bar-label';
    barLabel.textContent = distanceKm + 'km';
    
    const monthLabelDiv = document.createElement('div');
    monthLabelDiv.className = 'month-label';
    monthLabelDiv.textContent = monthLabel;
    
    bar.appendChild(barLabel);
    barContainer.appendChild(bar);
    barContainer.appendChild(monthLabelDiv);
    container.appendChild(barContainer);
  });
})();
</script>

<style>
.activities-graph {
  margin: 1rem 0;
}

.activities-graph h3 {
  margin: 0 0 1rem 0;
  text-align: center;
}

.graph-container {
  display: flex;
  gap: 8px;
  height: 300px;
  padding: 20px 0;
}

.bar-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  flex: 1;
  max-width: 60px;
  height: 100%;
}

.bar {
  width: 100%;
  background: linear-gradient(to top, #4CAF50, #8BC34A);
  border-radius: 4px 4px 0 0;
  position: relative;
  min-height: 4px;
}

.bar-label {
  position: absolute;
  top: -25px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 11px;
  white-space: nowrap;
}

.month-label {
  margin-top: 8px;
  font-size: 12px;
  color: #666;
  text-align: center;
  white-space: nowrap;
}

@media (max-width: 768px) {
  .graph-container {
    height: 250px;
    gap: 4px;
  }
  
  .bar-container {
    max-width: 20px;
    align-items: initial;
  }

  .bar-label {
    transform: rotate(90deg);
    transform-origin: left;
    top: -64px;
    left: 10px;
    font-size: 10px;
  }
  
  .month-label {
    font-size: 10px;
    transform: rotate(90deg);
    margin-top: 16px;
    text-align: right;
  }
}
</style>
